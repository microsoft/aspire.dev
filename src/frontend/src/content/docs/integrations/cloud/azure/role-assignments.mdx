---
title: Manage role assignments
description: Learn how to configure Azure role-based access control (RBAC) for Aspire applications.
---

import { Aside, Steps } from '@astrojs/starlight/components';

Azure role assignments control access to Azure resources using Azure role-based access control (RBAC). When deploying Aspire applications to Azure, proper role assignments ensure your services can access Azure resources securely using managed identities.

## How role assignments work in Aspire

Aspire automatically generates role assignments when you:

<Steps>
1. Add Azure resources to your AppHost
2. Reference those resources from your projects
3. Deploy to Azure (e.g., Azure Container Apps)
</Steps>

The generated infrastructure includes role assignments that grant your application's managed identity the necessary permissions.

## Automatic role assignment generation

When you reference an Azure resource, Aspire determines the required roles:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

var storage = builder.AddAzureStorage("storage");
var blobs = storage.AddBlobs("blobs");

// This project needs to access blobs
builder.AddProject<Projects.WebApp>("webapp")
       .WithReference(blobs);  // Generates role assignment
```

During deployment, Aspire automatically assigns the appropriate role (e.g., `Storage Blob Data Contributor`) to the `webapp` service's managed identity.

## Common role assignments by service

| Azure Service | Default Role | Purpose |
|--------------|--------------|---------|
| **Storage Blobs** | Storage Blob Data Contributor | Read/write blob data |
| **Storage Queues** | Storage Queue Data Contributor | Send/receive queue messages |
| **Storage Tables** | Storage Table Data Contributor | Read/write table data |
| **Service Bus** | Azure Service Bus Data Owner | Send/receive messages |
| **Event Hubs** | Azure Event Hubs Data Owner | Send/receive events |
| **Cosmos DB** | Cosmos DB Built-in Data Contributor | Read/write database data |
| **Key Vault** | Key Vault Secrets User | Read secrets |
| **App Configuration** | App Configuration Data Reader | Read configuration |

## Customizing role assignments

### Assign specific roles

You can customize which roles are assigned using `ConfigureInfrastructure`:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

var storage = builder.AddAzureStorage("storage");

storage.ConfigureInfrastructure(infra =>
{
    var account = infra.GetProvisionableResources()
                       .OfType<StorageAccount>()
                       .Single();
    
    // The role assignment will be created with custom roles
    // This is an advanced scenario
});
```

### Add additional role assignments

You can add role assignments for specific scenarios:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

var storage = builder.AddAzureStorage("storage");
var blobs = storage.AddBlobs("blobs");

var webapp = builder.AddProject<Projects.WebApp>("webapp")
                    .WithReference(blobs);

// The standard role assignment is automatic
// Add custom roles if needed via ConfigureInfrastructure
```

## User-assigned managed identities

By default, Aspire uses system-assigned managed identities. You can configure user-assigned identities:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

// Create a user-assigned identity
var identity = builder.AddAzureUserAssignedIdentity("myidentity");

var storage = builder.AddAzureStorage("storage");
var blobs = storage.AddBlobs("blobs");

// Use the user-assigned identity
builder.AddProject<Projects.WebApp>("webapp")
       .WithReference(blobs)
       .WithIdentity(identity);
```

For more information, see [User-assigned identity](/integrations/cloud/azure/user-assigned-identity/).

## Least privilege principle

Aspire follows the principle of least privilege by assigning only the necessary roles. For example:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

var storage = builder.AddAzureStorage("storage");
var blobs = storage.AddBlobs("blobs");

// Read-only project - would get reader role in production
builder.AddProject<Projects.ReadOnlyApp>("readonly")
       .WithReference(blobs);

// Read-write project - gets contributor role
builder.AddProject<Projects.WriteApp>("writeapp")
       .WithReference(blobs);
```

<Aside type="tip">
In production deployments, review the generated role assignments in the Bicep files to ensure they match your security requirements.
</Aside>

## Role assignment propagation

After deployment, role assignments may take a few minutes to propagate throughout Azure. If you see authentication errors immediately after deployment:

<Steps>
1. Wait 2-3 minutes for propagation
2. Restart your application
3. Check role assignments in the Azure Portal
</Steps>

## Verifying role assignments

To verify role assignments in the Azure Portal:

<Steps>
1. Navigate to your Azure resource (e.g., Storage Account)
2. Select **Access Control (IAM)**
3. Click **Role assignments**
4. Look for your application's managed identity
</Steps>

Or use Azure CLI:

```bash
az role assignment list \
  --scope /subscriptions/{subscription-id}/resourceGroups/{rg-name}/providers/Microsoft.Storage/storageAccounts/{account-name} \
  --output table
```

## Troubleshooting

### Authentication failures

If you see errors like "AuthorizationPermissionMismatch" or "Forbidden":

<Steps>
1. **Check role assignments**: Verify the role exists in Azure Portal
2. **Wait for propagation**: Azure RBAC can take up to 5 minutes
3. **Verify managed identity**: Ensure your app uses managed identity
4. **Check resource name**: Verify connection string matches deployed resource
</Steps>

### Missing permissions

If your application needs additional permissions:

<Steps>
1. Identify the required Azure role
2. Add role assignment via ConfigureInfrastructure or Azure Portal
3. Restart your application
</Steps>

### Development vs. production

Role assignments are for Azure-deployed resources. During local development:

- Use connection strings with access keys.
- Use Azure CLI credentials (`az login`).
- Use emulators (Azurite, Service Bus Emulator).

## Security best practices

### Use managed identities

Always use managed identities in production rather than connection strings with keys:

```csharp
// ✅ Good - Uses managed identity
builder.AddAzureBlobClient("blobs");

// ❌ Avoid in production - Exposes keys
builder.Services.Configure<BlobClientOptions>(options => 
{
    options.ConnectionString = "DefaultEndpointsProtocol=https;AccountName=...;AccountKey=...";
});
```

### Limit role scope

Assign roles at the most specific scope:

- **Best**: Specific resource (e.g., one storage account).
- **Good**: Resource group.
- **Avoid**: Subscription level.

### Regular audits

Regularly review role assignments:

```bash
az role assignment list --resource-group my-rg --output table
```

### Use custom roles for fine-grained control

For very specific scenarios, create custom roles:

```bicep
resource customRole 'Microsoft.Authorization/roleDefinitions@2022-04-01' = {
  name: guid(subscription().id, 'custom-role')
  properties: {
    roleName: 'Custom Storage Reader'
    description: 'Read-only access to specific containers'
    permissions: [
      {
        actions: [
          'Microsoft.Storage/storageAccounts/blobServices/containers/read'
        ]
        dataActions: [
          'Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read'
        ]
      }
    ]
  }
}
```

## See also

- [Azure integrations overview](/integrations/cloud/azure/overview/)
- [User-assigned identity](/integrations/cloud/azure/user-assigned-identity/)
- [Deploy to Azure Container Apps](/get-started/deploy-first-app/)
- [Azure RBAC documentation](https://learn.microsoft.com/role-based-access-control/overview)
