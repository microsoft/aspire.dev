---
title: User-assigned managed identity
description: Learn how to configure user-assigned managed identities for Aspire applications in Azure.
next: false
---

import { Aside, Steps } from '@astrojs/starlight/components';

User-assigned managed identities provide a way to grant your Aspire applications access to Azure resources without managing credentials. Unlike system-assigned identities (which are tied to a single resource), user-assigned identities can be shared across multiple resources.

## What is a user-assigned managed identity?

A user-assigned managed identity is:

- **A standalone Azure resource**: Created independently of your application.
- **Reusable**: Can be assigned to multiple Azure resources.
- **Managed by Azure**: No credential management required.
- **RBAC-compatible**: Supports role-based access control.

## Why use user-assigned identities?

### Advantages over system-assigned identities

| Feature | System-Assigned | User-Assigned |
|---------|-----------------|---------------|
| **Lifecycle** | Tied to resource | Independent |
| **Sharing** | One per resource | Shared across resources |
| **Management** | Automatic | Manual creation |
| **Flexibility** | Limited | High |
| **Use case** | Simple scenarios | Complex deployments |

### Common scenarios

- **Shared access**: Multiple apps accessing the same resources.
- **Pre-provisioning**: Create identities before deploying apps.
- **Centralized management**: Manage permissions separately from apps.
- **Multi-region**: Same identity across regions.

## Creating a user-assigned identity

### In your AppHost

Add a user-assigned identity to your AppHost project:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

// Create a user-assigned identity
var identity = builder.AddAzureUserAssignedIdentity("myidentity");

var storage = builder.AddAzureStorage("storage");
var blobs = storage.AddBlobs("blobs");

// Assign the identity to your project
builder.AddProject<Projects.WebApp>("webapp")
       .WithReference(blobs)
       .WithIdentity(identity);

// Multiple projects can share the same identity
builder.AddProject<Projects.ApiService>("api")
       .WithReference(blobs)
       .WithIdentity(identity);
```

The preceding code:

<Steps>
1. Creates a user-assigned identity named `myidentity`
2. Adds an Azure Storage resource
3. Assigns the identity to both `webapp` and `api` projects
4. Both projects will use the same identity to access storage
</Steps>

### Connect to an existing identity

To use an existing user-assigned identity:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

var existingIdentityName = builder.AddParameter("existingIdentityName");
var existingIdentityResourceGroup = builder.AddParameter("existingIdentityResourceGroup");

var identity = builder.AddAzureUserAssignedIdentity("myidentity")
                      .AsExisting(existingIdentityName, existingIdentityResourceGroup);

builder.AddProject<Projects.WebApp>("webapp")
       .WithIdentity(identity);
```

## Configuring role assignments

When you use a user-assigned identity, Aspire automatically creates role assignments:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

var identity = builder.AddAzureUserAssignedIdentity("shared-identity");

var storage = builder.AddAzureStorage("storage");
var blobs = storage.AddBlobs("blobs");

var keyVault = builder.AddAzureKeyVault("keyvault");

// Identity gets roles for both storage and key vault
builder.AddProject<Projects.WebApp>("webapp")
       .WithReference(blobs)
       .WithReference(keyVault)
       .WithIdentity(identity);
```

During deployment, the identity receives:
- **Storage Blob Data Contributor** for the storage account
- **Key Vault Secrets User** for the key vault

## Using in your application code

Your application code doesn't change when using user-assigned identities. Azure SDK clients automatically use the assigned identity:

```csharp title="C# — BlobService.cs"
public class BlobService(BlobServiceClient blobClient)
{
    public async Task UploadAsync(
        string containerName, string blobName, Stream content)
    {
        var container = blobClient.GetBlobContainerClient(containerName);

        await container.UploadBlobAsync(blobName, content);
        
        // Authentication handled automatically via managed identity
    }
}
```

## Deployment

### Generated infrastructure

When you deploy, Aspire generates Bicep that:

<Steps>
1. Creates the user-assigned identity (if not existing)
2. Assigns the identity to your Container Apps
3. Creates role assignments for accessed resources
</Steps>

Example generated Bicep:

```bicep
resource userIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: 'myidentity'
  location: location
}

resource webapp 'Microsoft.App/containerApps@2024-03-01' = {
  name: 'webapp'
  identity: {
    type: 'UserAssigned'
    userAssignedIdentities: {
      '${userIdentity.id}': {}
    }
  }
  // ...
}

resource roleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(storageAccount.id, userIdentity.id, 'StorageBlobDataContributor')
  scope: storageAccount
  properties: {
    principalId: userIdentity.properties.principalId
    roleDefinitionId: subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')
  }
}
```

### Verifying deployment

After deployment, verify the identity in Azure portal:

<Steps>
1. Navigate to **Managed Identities** in Azure portal.
2. Find your user-assigned identity.
3. Click **Azure role assignments**.
4. Verify the roles are correctly assigned.
</Steps>

## Comparison: System-assigned vs. User-assigned

### Use system-assigned when:

- Application has 1:1 relationship with resources
- Simple deployment scenarios
- Minimal identity management overhead
- Identity lifecycle matches app lifecycle

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

// System-assigned - simple, automatic
builder.AddProject<Projects.WebApp>("webapp")
       .WithReference(storage);
// Identity created automatically
```

### Use user-assigned when:

- Multiple apps share resources.
- Identity needs to outlive the app.
- Centralized identity management.
- Pre-provisioned identities required.

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

// User-assigned - explicit, shared
var identity = builder.AddAzureUserAssignedIdentity("shared");

builder.AddProject<Projects.WebApp>("webapp")
       .WithIdentity(identity);

builder.AddProject<Projects.ApiService>("api")
       .WithIdentity(identity);
```

## Security best practices

### Principle of least privilege

Grant only necessary permissions:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

// ✅ Good - Specific access
var readIdentity = builder.AddAzureUserAssignedIdentity("reader");
var writeIdentity = builder.AddAzureUserAssignedIdentity("writer");

builder.AddProject<Projects.ReadApp>("read")
    .WithReference(storage)
    .WithIdentity(readIdentity);  // Gets reader role

builder.AddProject<Projects.WriteApp>("write")
    .WithReference(storage)
    .WithIdentity(writeIdentity);  // Gets contributor role
```

### Separate identities by function

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

var apiIdentity = builder.AddAzureUserAssignedIdentity("api-identity");
var workerIdentity = builder.AddAzureUserAssignedIdentity("worker-identity");

// API needs different permissions than worker
builder.AddProject<Projects.ApiService>("api")
    .WithIdentity(apiIdentity);

builder.AddProject<Projects.WorkerService>("worker")
    .WithIdentity(workerIdentity);
```

### Regular audits

Periodically review identity assignments:

```bash
az identity list --resource-group my-rg --output table
az role assignment list --assignee <identity-principal-id> --output table
```

## Troubleshooting

### Identity not found

If deployment fails with "identity not found":

<Steps>
1. Verify the identity exists in Azure portal.
2. Check the resource group matches.
3. Ensure proper naming.
4. Verify subscription access.
</Steps>

### Permission denied errors

If you see authorization errors:

<Steps>
1. Check role assignments in Azure portal
2. Wait 5 minutes for RBAC propagation
3. Verify identity is assigned to the container app
4. Check the identity has the correct roles
</Steps>

### Multiple identities conflict

If using both system-assigned and user-assigned:

```csharp title="C# — AppHost.cs"
var builder = DistributedApplication.CreateBuilder(args);

// Specify which identity to use for specific resources
var identity = builder.AddAzureUserAssignedIdentity("myidentity");

builder.AddProject<Projects.WebApp>("webapp")
    .WithIdentity(identity);  // Uses user-assigned
    // System-assigned is also created but not used
```

## See also

- [Azure role assignments](/integrations/cloud/azure/role-assignments/)
- [Azure integrations overview](/integrations/cloud/azure/overview/)
- [Deploy to Azure Container Apps](/get-started/deploy-first-app/)
- [Azure Managed Identities documentation](https://learn.microsoft.com/active-directory/managed-identities-azure-resources/overview)
