---
// Main Playground Layout Component (Astro)
import AspirePlayground from './AspirePlayground';
import ResourcePalette from './ResourcePalette';
import CodePreview from './CodePreview';
---

<div class="playground-wrapper" id="aspire-playground-wrapper">
  <div class="playground-container" id="playground-container">
    <div class="palette-section" id="palette-section">
      <ResourcePalette client:only="react" onAddResource={(resource: any) => {
        const event = new CustomEvent('add-resource', { detail: resource });
        window.dispatchEvent(event);
      }} />
    </div>
    
    <div class="resize-handle palette-resize" id="palette-resize" data-direction="horizontal"></div>
    
    <div class="canvas-section">
      <AspirePlayground client:only="react" />
    </div>

    <div class="resize-handle code-resize" id="code-resize" data-direction="horizontal" style="display: none;"></div>
    
    <div class="code-section" id="code-section" style="display: none;">
      <CodePreview client:only="react" code={{appHost: '', nugetPackages: [], deploymentOptions: []}} onClose={() => {
        document.getElementById('code-section')!.style.display = 'none';
        document.getElementById('code-resize')!.style.display = 'none';
        localStorage.setItem('aspire-playground-show-code', 'false');
      }} />
    </div>
  </div>

  <div class="playground-toolbar">
    <button class="toolbar-btn" id="toggle-palette" title="Toggle Resource Palette">
      <span class="btn-icon">â—€</span>
      <span class="btn-text">Palette</span>
    </button>
    <button class="toolbar-btn" id="toggle-layout" title="Switch Layout">
      <span class="btn-icon">â‡„</span>
      <span class="btn-text">Layout</span>
    </button>
    <button class="toolbar-btn primary" id="toggle-code" title="View Generated Code">
      <span class="btn-icon">ðŸ’»</span>
      <span class="btn-text">Code</span>
    </button>
  </div>
</div>

<style>
  .playground-wrapper {
    width: calc(100vw - 2rem);
    height: calc(100vh - var(--sl-nav-height, 64px) - 2rem);
    min-height: 600px;
    margin: 1rem;
    position: relative;
    display: flex;
    flex-direction: column;
    background: var(--sl-color-bg);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 8px;
    overflow: hidden;
  }

  .playground-container {
    flex: 1;
    display: grid;
    grid-template-columns: 300px 4px 1fr;
    grid-template-rows: 1fr;
    position: relative;
    overflow: hidden;
  }

  .playground-container.vertical {
    grid-template-columns: 1fr;
    grid-template-rows: 300px 4px 1fr;
  }

  .playground-container.hide-palette {
    grid-template-columns: 0 0 1fr;
  }

  .playground-container.vertical.hide-palette {
    grid-template-rows: 0 0 1fr;
  }

  .playground-container.show-code:not(.vertical) {
    grid-template-columns: 300px 4px 1fr 4px 600px;
  }

  .playground-container.vertical.show-code {
    grid-template-rows: 300px 4px 1fr 4px 400px;
  }

  .palette-section {
    height: 100%;
    overflow: hidden;
    background: var(--sl-color-bg-nav);
  }

  .canvas-section {
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  .code-section {
    height: 100%;
    overflow: hidden;
    background: var(--sl-color-bg-nav);
    border-left: 1px solid var(--sl-color-gray-5);
  }

  .playground-container.vertical .code-section {
    border-left: none;
    border-top: 1px solid var(--sl-color-gray-5);
  }

  .resize-handle {
    background: var(--sl-color-gray-5);
    cursor: ew-resize;
    transition: background 0.2s;
    position: relative;
    z-index: 10;
  }

  .resize-handle:hover,
  .resize-handle:active {
    background: var(--sl-color-accent);
  }

  .resize-handle[data-direction="vertical"] {
    cursor: ns-resize;
  }

  .playground-toolbar {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--sl-color-bg-nav);
    border-top: 1px solid var(--sl-color-gray-5);
    flex-wrap: wrap;
  }

  .toolbar-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 6px;
    color: var(--sl-color-white);
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .toolbar-btn:hover {
    background: var(--sl-color-gray-5);
    transform: translateY(-1px);
  }

  .toolbar-btn.primary {
    background: var(--sl-color-accent);
    border-color: var(--sl-color-accent);
  }

  .toolbar-btn.primary:hover {
    opacity: 0.9;
  }

  .toolbar-btn.active {
    background: var(--sl-color-accent);
    border-color: var(--sl-color-accent);
  }

  .btn-icon {
    font-size: 1.125rem;
    line-height: 1;
  }

  @media (max-width: 768px) {
    .btn-text {
      display: none;
    }
  }
</style>

<script>
  // Playground Layout Manager
  class PlaygroundLayoutManager {
    private container: HTMLElement;
    private paletteSection: HTMLElement;
    private codeSection: HTMLElement;
    private paletteResize: HTMLElement;
    private codeResize: HTMLElement;
    private togglePaletteBtn: HTMLElement;
    private toggleLayoutBtn: HTMLElement;
    private toggleCodeBtn: HTMLElement;
    
    private isResizingPalette = false;
    private isResizingCode = false;
    private layoutMode: 'horizontal' | 'vertical' = 'horizontal';
    private showPalette = true;
    private showCode = false;
    
    constructor() {
      this.container = document.getElementById('playground-container')!;
      this.paletteSection = document.getElementById('palette-section')!;
      this.codeSection = document.getElementById('code-section')!;
      this.paletteResize = document.getElementById('palette-resize')!;
      this.codeResize = document.getElementById('code-resize')!;
      this.togglePaletteBtn = document.getElementById('toggle-palette')!;
      this.toggleLayoutBtn = document.getElementById('toggle-layout')!;
      this.toggleCodeBtn = document.getElementById('toggle-code')!;
      
      this.loadPreferences();
      this.setupEventListeners();
      this.applyLayout();
    }
    
    private loadPreferences() {
      const savedLayout = localStorage.getItem('aspire-playground-layout');
      const savedShowPalette = localStorage.getItem('aspire-playground-show-palette');
      const savedShowCode = localStorage.getItem('aspire-playground-show-code');
      const savedPaletteSize = localStorage.getItem('aspire-playground-palette-size');
      const savedCodeSize = localStorage.getItem('aspire-playground-code-size');
      
      if (savedLayout) this.layoutMode = savedLayout as 'horizontal' | 'vertical';
      if (savedShowPalette) this.showPalette = savedShowPalette === 'true';
      if (savedShowCode) this.showCode = savedShowCode === 'true';
      
      if (savedPaletteSize) {
        const size = parseInt(savedPaletteSize);
        if (this.layoutMode === 'horizontal') {
          this.paletteSection.style.width = `${size}px`;
        } else {
          this.paletteSection.style.height = `${size}px`;
        }
      }
      
      if (savedCodeSize) {
        const size = parseInt(savedCodeSize);
        if (this.layoutMode === 'horizontal') {
          this.codeSection.style.width = `${size}px`;
        } else {
          this.codeSection.style.height = `${size}px`;
        }
      }
    }
    
    private setupEventListeners() {
      // Toggle buttons
      this.togglePaletteBtn.addEventListener('click', () => this.togglePalette());
      this.toggleLayoutBtn.addEventListener('click', () => this.toggleLayout());
      this.toggleCodeBtn.addEventListener('click', () => this.toggleCode());
      
      // Resize handles
      this.paletteResize.addEventListener('mousedown', () => this.isResizingPalette = true);
      this.codeResize.addEventListener('mousedown', () => this.isResizingCode = true);
      
      document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
      document.addEventListener('mouseup', () => {
        this.isResizingPalette = false;
        this.isResizingCode = false;
      });
    }
    
    private handleMouseMove(e: MouseEvent) {
      if (this.isResizingPalette) {
        const size = this.layoutMode === 'horizontal' ? e.clientX : e.clientY;
        const minSize = 200;
        const maxSize = this.layoutMode === 'horizontal' ? 500 : 600;
        
        if (size >= minSize && size <= maxSize) {
          if (this.layoutMode === 'horizontal') {
            this.container.style.gridTemplateColumns = `${size}px 4px 1fr${this.showCode ? ' 4px 600px' : ''}`;
          } else {
            this.container.style.gridTemplateRows = `${size}px 4px 1fr${this.showCode ? ' 4px 400px' : ''}`;
          }
          localStorage.setItem('aspire-playground-palette-size', size.toString());
        }
      }
      
      if (this.isResizingCode) {
        const containerSize = this.layoutMode === 'horizontal' ? window.innerWidth : window.innerHeight;
        const size = containerSize - (this.layoutMode === 'horizontal' ? e.clientX : e.clientY);
        const minSize = this.layoutMode === 'horizontal' ? 400 : 300;
        const maxSize = this.layoutMode === 'horizontal' ? 800 : 700;
        
        if (size >= minSize && size <= maxSize) {
          const paletteSize = this.layoutMode === 'horizontal'
            ? this.paletteSection.offsetWidth
            : this.paletteSection.offsetHeight;
          
          if (this.layoutMode === 'horizontal') {
            this.container.style.gridTemplateColumns = `${paletteSize}px 4px 1fr 4px ${size}px`;
          } else {
            this.container.style.gridTemplateRows = `${paletteSize}px 4px 1fr 4px ${size}px`;
          }
          localStorage.setItem('aspire-playground-code-size', size.toString());
        }
      }
    }
    
    private togglePalette() {
      this.showPalette = !this.showPalette;
      localStorage.setItem('aspire-playground-show-palette', this.showPalette.toString());
      this.applyLayout();
      
      const icon = this.togglePaletteBtn.querySelector('.btn-icon')!;
      icon.textContent = this.showPalette ? (this.layoutMode === 'horizontal' ? 'â—€' : 'â–²') : (this.layoutMode === 'horizontal' ? 'â–¶' : 'â–¼');
      this.togglePaletteBtn.classList.toggle('active', !this.showPalette);
    }
    
    private toggleLayout() {
      this.layoutMode = this.layoutMode === 'horizontal' ? 'vertical' : 'horizontal';
      localStorage.setItem('aspire-playground-layout', this.layoutMode);
      this.applyLayout();
      
      const icon = this.toggleLayoutBtn.querySelector('.btn-icon')!;
      icon.textContent = this.layoutMode === 'horizontal' ? 'â‡„' : 'â‡…';
      
      // Update palette toggle icon
      const paletteIcon = this.togglePaletteBtn.querySelector('.btn-icon')!;
      paletteIcon.textContent = this.showPalette 
        ? (this.layoutMode === 'horizontal' ? 'â—€' : 'â–²')
        : (this.layoutMode === 'horizontal' ? 'â–¶' : 'â–¼');
    }
    
    private toggleCode() {
      this.showCode = !this.showCode;
      localStorage.setItem('aspire-playground-show-code', this.showCode.toString());
      this.applyLayout();
      
      this.codeSection.style.display = this.showCode ? 'block' : 'none';
      this.codeResize.style.display = this.showCode ? 'block' : 'none';
      
      const text = this.toggleCodeBtn.querySelector('.btn-text')!;
      text.textContent = this.showCode ? 'Builder' : 'Code';
    }
    
    private applyLayout() {
      this.container.classList.toggle('vertical', this.layoutMode === 'vertical');
      this.container.classList.toggle('hide-palette', !this.showPalette);
      this.container.classList.toggle('show-code', this.showCode);
      
      // Update resize handle directions
      const direction = this.layoutMode === 'horizontal' ? 'horizontal' : 'vertical';
      this.paletteResize.setAttribute('data-direction', direction);
      this.codeResize.setAttribute('data-direction', direction);
      
      // Update visibility
      this.paletteSection.style.display = this.showPalette ? 'block' : 'none';
      this.paletteResize.style.display = this.showPalette ? 'block' : 'none';
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new PlaygroundLayoutManager();
    });
  } else {
    new PlaygroundLayoutManager();
  }
</script>
