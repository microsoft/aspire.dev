---
import { CardGrid, Card } from '@astrojs/starlight/components';
import IntegrationCard from '@components/IntegrationCard.astro';
import IntegrationTotals from '@components/IntegrationTotals.astro';

interface Props {
  integrations: Integrations;
  availableDocs: AvailableDocs;
}

const { integrations, availableDocs } = Astro.props;

interface Integration {
  title: string;
  href: string;
  icon: string;
  description: string;
  downloads?: number;
  version?: string;
  tags?: string[];
  docs?: string;
}

type Integrations = Integration[];

interface AvailableDoc {
  match: string;
  href: string;
}

type AvailableDocs = AvailableDoc[];

const sortedIntegrations = integrations.sort((a, b) => {
  const aDownloads = a.downloads ?? 0;
  const bDownloads = b.downloads ?? 0;
  return bDownloads - aDownloads; // Sort by downloads descending
});
---

<div class="sl-mb-4 search-wrapper not-content">
  <div class="search-container">
    <svg
      class="search-icon"
      aria-hidden="true"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
    <input
      autocomplete="off"
      spellcheck="false"
      type="text"
      class="search-box filter"
      placeholder={Astro.locals.t('integrations.search')}
    />
    <button class="clear-button" aria-label="Clear search" type="button">
      {Astro.locals.t('integrations.clear')}
    </button>
  </div>
  <div class="type-toggle-group">
    <button
      class="type-toggle active"
      data-type="official"
      title={Astro.locals.t('integrations.officialTooltip')}
      data-tooltip-placement="top"
      type="button"
    >
      <svg class="type-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M10.521 2.624a2 2 0 0 1 2.958 0l1.02 1.12a2 2 0 0 0 1.572.651l1.513-.07a2 2 0 0 1 2.092 2.09l-.071 1.514a2 2 0 0 0 .651 1.572l1.12 1.02a2 2 0 0 1 0 2.958l-1.12 1.02a2 2 0 0 0-.651 1.572l.07 1.513a2 2 0 0 1-2.09 2.092l-1.514-.071a2 2 0 0 0-1.572.651l-1.02 1.12a2 2 0 0 1-2.958 0l-1.02-1.12a2 2 0 0 0-1.572-.651l-1.513.07a2 2 0 0 1-2.092-2.09l.071-1.514a2 2 0 0 0-.651-1.572l-1.12-1.02a2 2 0 0 1 0-2.958l1.12-1.02a2 2 0 0 0 .651-1.572l-.07-1.513a2 2 0 0 1 2.09-2.092l1.514.071a2 2 0 0 0 1.572-.651z"/><path stroke-linecap="round" stroke-linejoin="round" d="m9 12l2 2l4-4"/></svg>
      {Astro.locals.t('integrations.official')}
    </button>
    <button
      class="type-toggle active"
      data-type="community"
      title={Astro.locals.t('integrations.communityTooltip')}
      data-tooltip-placement="top"
      type="button"
    >
      <svg class="type-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="M7 18v-1a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v1M1 18v-1a3 3 0 0 1 3-3v0m19 4v-1a3 3 0 0 0-3-3v0m-8-2a3 3 0 1 0 0-6a3 3 0 0 0 0 6m-8 2a2 2 0 1 0 0-4a2 2 0 0 0 0 4m16 0a2 2 0 1 0 0-4a2 2 0 0 0 0 4"/></svg>
      {Astro.locals.t('integrations.community')}
    </button>
  </div>
  <div class="type-toggle-group">
    <button
      class="type-toggle active"
      data-type="hosting"
      title={Astro.locals.t('integrations.hostingTooltip')}
      data-tooltip-placement="top"
      type="button"
    >
      <svg
        class="type-icon"
        aria-hidden="true"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="1.5"
        ><path d="M3 19h9m9 0h-9m0 0v-6m0 0h6V5H6v8zM9 9.01l.01-.011M12 9.01l.01-.011"></path></svg
      >
      {Astro.locals.t('integrations.hosting')}
    </button>
    <button
      class="type-toggle active"
      data-type="client"
      title={Astro.locals.t('integrations.clientTooltip')}
      data-tooltip-placement="top"
      type="button"
    >
      <svg
        class="type-icon"
        aria-hidden="true"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        ><path d="M2 19V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z"
        ></path><path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M2 7h20M5 5.01l.01-.011M8 5.01l.01-.011M11 5.01l.01-.011"></path></svg
      >
      {Astro.locals.t('integrations.client')}
    </button>
  </div>
</div>

{
  sortedIntegrations.length > 0 && (
    <section>
      <div class="integration-stats">
        <IntegrationTotals integrations={sortedIntegrations} />
      </div>

      <div class="equal-columns">
        <CardGrid>
          {sortedIntegrations.map((pkg) => {
            // Find a matching doc by checking if pkg.title.
            const doc = availableDocs.find((doc) => {
              const match = doc.match.toLowerCase();
              const titleMatch = pkg.title.toLowerCase() == match;
              return titleMatch;
            });

            // Assign docs property if a match is found
            const pkgWithDocs = doc ? { ...pkg, docs: doc.href } : pkg;

            return <IntegrationCard pkg={pkgWithDocs} />;
          })}
        </CardGrid>
      </div>

      <div class="no-results">
        <Card title="No integrations found" icon="magnifier">
          {Astro.locals.t('integrations.noResults')}
        </Card>
      </div>
    </section>
  )
}

<style>
  .no-results {
    margin-top: 0;
    display: none; /* Hidden by default */
  }

  .integration-stats {
    margin-bottom: 1rem;
    display: none; /* Hidden by default on mobile */
  }

  /* Force equal columns in the card grid */
  .equal-columns :global(.card-grid) {
    display: grid;
    grid-template-columns: 1fr; /* Default to single column for mobile */
    width: 100%;
    gap: 1rem; /* Ensure consistent spacing */
  }

  /* Ensure each card takes full space in its column */
  .equal-columns :global(.card-grid > *) {
    width: 100%;
    box-sizing: border-box;
    min-width: 0;
    max-width: 100%;
  }

  /* Switch to two columns on larger screens and show stats */
  @media (min-width: 768px) {
    .equal-columns :global(.card-grid) {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .integration-stats {
      display: block; /* Show stats on larger screens */
    }
  }

  .search-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    width: 100%;
  }

  /* Small: all three stack full-width */
  .search-container {
    flex: 1 1 100%;
  }

  .type-toggle-group {
    flex: 1 1 100%;
  }

  .type-toggle-group .type-toggle {
    flex: 1;
  }

  /* Mid: search full-width, both toggle groups share a row */
  @media (min-width: 50em) {
    .search-wrapper {
      gap: 0.75rem;
    }

    .type-toggle-group {
      flex: 0 0 auto;
    }
  }

  /* Large: everything on one row */
  @media (min-width: 72rem) {
    .search-container {
      flex: 1 1 0;
    }

    .type-toggle-group {
      flex: 0 0 auto;
    }
  }

  .search-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  input.filter {
    padding-inline-start: 2.5rem;
    padding-inline-end: 4.5rem;
    background-color: var(--sl-color-black);
    color: var(--sl-color-text);
    font-size: var(--sl-text);
    width: 100%;
    height: 2.5rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    font-size: calc(21px * var(--pagefind-ui-scale));
    position: relative;
    display: flex;
    box-sizing: border-box;
  }

  .search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--sl-color-gray-4);
    pointer-events: none;
    z-index: 1;
  }

  .clear-button {
    position: absolute;
    right: 0.375rem;
    top: 50%;
    transform: translateY(-50%);
    background-color: var(--sl-color-gray-6);
    border: 1px solid var(--sl-color-gray-5);
    color: var(--sl-color-gray-3);
    cursor: pointer;
    padding: 0.125rem 0.5rem;
    display: none;
    align-items: center;
    justify-content: center;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    line-height: 1.5;
    transition:
      color 0.2s ease,
      background-color 0.2s ease;
    z-index: 1;
  }

  .clear-button:hover {
    color: var(--sl-color-text);
    background-color: var(--sl-color-gray-5);
  }

  .clear-button.visible {
    display: flex;
  }

  .type-toggle-group {
    display: flex;
    border-radius: 0.375rem;
    overflow: hidden;
    border: 1px solid var(--sl-color-gray-5);
    height: 2.5rem;
    box-sizing: border-box;
  }

  .type-toggle {
    background-color: var(--sl-color-gray-6);
    border: none;
    border-inline-end: 1px solid var(--sl-color-gray-5);
    color: var(--sl-color-text);
    cursor: pointer;
    font-size: 0.875rem;
    padding: 0 0.75rem;
    height: 100%;
    transition:
      background-color 0.2s ease,
      color 0.2s ease,
      opacity 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    white-space: nowrap;
  }

  .type-toggle:last-child {
    border-inline-end: none;
  }

  .type-toggle:hover {
    background-color: var(--sl-color-gray-5);
  }

  .type-toggle.active {
    background-color: var(--sl-color-accent);
    color: var(--sl-color-white);
  }

  .type-toggle.active:hover {
    opacity: 0.9;
  }

  .type-toggle .type-icon {
    flex-shrink: 0;
  }

  .type-toggle.active .type-icon {
    stroke: var(--sl-color-white);
  }

  .type-toggle:not(.active) {
    opacity: 0.6;
  }

  .type-toggle:not(.active):hover {
    opacity: 0.8;
  }

  :root[data-theme='light'] {
    .type-toggle:not(.active) {
      color: #6a6a75;
    }

    .type-toggle.active {
      background-color: var(--sl-color-accent);
      color: var(--sl-color-black);
    }

    .type-toggle.active .type-icon {
      stroke: var(--sl-color-black);
    }
  }
</style>

<script type="module" is:inline>
  const searchBox = document.querySelector('.search-box');
  const clearButton = document.querySelector('.clear-button');
  const officialToggle = document.querySelector('.type-toggle[data-type="official"]');
  const communityToggle = document.querySelector('.type-toggle[data-type="community"]');
  const hostingToggle = document.querySelector('.type-toggle[data-type="hosting"]');
  const clientToggle = document.querySelector('.type-toggle[data-type="client"]');
  const cards = document.querySelectorAll('.card-grid .card');
  const noResults = document.querySelector('.no-results');
  const statsSection = document.querySelector('.integration-stats');

  let activeTags = new Set();
  let showOfficial = true;
  let showCommunity = true;
  let showHosting = true;
  let showClient = true;

  const urlParams = new URLSearchParams(window.location.search);
  const initialSearch = urlParams.get('search') || '';
  const initialOfficial = urlParams.get('official');
  const initialCommunity = urlParams.get('community');
  const initialHosting = urlParams.get('hosting');
  const initialClient = urlParams.get('client');

  if (initialSearch) {
    searchBox.value = initialSearch;
  }

  if (initialOfficial === 'false') {
    showOfficial = false;
    officialToggle.classList.remove('active');
  }

  if (initialCommunity === 'false') {
    showCommunity = false;
    communityToggle.classList.remove('active');
  }

  if (initialHosting === 'false') {
    showHosting = false;
    hostingToggle.classList.remove('active');
  }

  if (initialClient === 'false') {
    showClient = false;
    clientToggle.classList.remove('active');
  }

  function updateClearButton() {
    if (searchBox.value.length > 0) {
      clearButton.classList.add('visible');
    } else {
      clearButton.classList.remove('visible');
    }
  }

  function updateURL() {
    const params = new URLSearchParams();
    if (activeTags.size > 0) params.set('tags', [...activeTags].join(','));
    if (searchBox.value.trim()) params.set('search', searchBox.value.trim());
    if (!showOfficial) params.set('official', 'false');
    if (!showCommunity) params.set('community', 'false');
    if (!showHosting) params.set('hosting', 'false');
    if (!showClient) params.set('client', 'false');
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    history.pushState({}, '', newUrl);
  }

  function clearSearch() {
    searchBox.value = '';
    updateClearButton();
    filterCards();
    searchBox.focus();
  }

  function updateTotals(visibleCards) {
    // Get the IntegrationTotals component
    const totalsComponent = document.querySelector('.integration-totals');
    if (!totalsComponent) return;

    // Extract data from visible cards
    const visibleIntegrations = Array.from(visibleCards).map((card) => ({
      title: card.dataset.title || '',
      downloads: parseInt(card.dataset.downloads || '0'),
      tags: card.dataset.tags ? card.dataset.tags.split(',') : [],
    }));

    // Calculate new stats
    const totalPackages = visibleIntegrations.length;

    // Calculate unique tags from visible integrations
    const uniqueTags = new Set();
    visibleIntegrations.forEach((pkg) => {
      if (pkg.tags) pkg.tags.forEach((tag) => uniqueTags.add(tag));
    });
    const totalTags = uniqueTags.size;

    // Calculate total downloads from visible integrations
    const totalDownloads = visibleIntegrations.reduce((sum, pkg) => sum + (pkg.downloads || 0), 0);

    // Update the data-target attributes for each total card
    const totalCards = totalsComponent.querySelectorAll('.total-card .total-number');
    if (totalCards.length >= 3) {
      // Update packages count
      totalCards[0].setAttribute('data-target', totalPackages);

      // Update tags count
      totalCards[1].setAttribute('data-target', totalTags);

      // Update downloads count
      totalCards[2].setAttribute('data-target', totalDownloads);
    }

    // After updating the data-target attributes, trigger the animation if enabled in config
    if (window.animateIntegrationTotals) {
      window.animateIntegrationTotals();
    }
  }

  function filterCards(updateUrl = true) {
    const searchTerm = searchBox.value.toLowerCase().trim();
    let visibleCount = 0;
    const visibleCards = [];

    // Split search term by spaces to support multiple keywords
    const searchTerms = searchTerm ? searchTerm.split(/\s+/).filter((term) => term.length > 0) : [];

    cards.forEach((card) => {
      const cardTags = card.dataset.tags ? card.dataset.tags.split(',') : [];
      const cardTitle = card.dataset.title ? card.dataset.title.toLowerCase() : '';
      const cardDescription = card.dataset.description
        ? card.dataset.description.toLowerCase()
        : '';

      // Match against tags
      const matchesTags = [...activeTags].every((tag) => cardTags.includes(tag));

      // Check if ALL search terms appear in title, tags, or description
      const matchesSearch =
        searchTerms.length === 0 ||
        searchTerms.some(
          (term) =>
            cardTitle.includes(term) ||
            cardDescription.includes(term) ||
            cardTags.some((tag) => tag.toLowerCase().includes(term))
        );

      // Official/Community filter
      const isCommunity = cardTitle.startsWith('communitytoolkit.');
      const isOfficial = !isCommunity;
      const matchesSource = (showOfficial || !isOfficial) && (showCommunity || !isCommunity);

      // Type filters: hide cards with hosting/client tags when toggled off
      const isHosting =
        cardTags.includes('hosting') ||
        /\.aspire\.hosting\./i.test(cardTitle) ||
        cardTitle.startsWith('aspire.hosting.');
      const isClient =
        cardTags.includes('client') ||
        (!isHosting && (cardTitle.startsWith('aspire.') || /\.aspire\./i.test(cardTitle)));
      const matchesType = (showHosting || !isHosting) && (showClient || !isClient);

      const visible = matchesTags && matchesSearch && matchesSource && matchesType;
      card.style.display = visible ? '' : 'none';

      if (visible) {
        visibleCount++;
        visibleCards.push(card);
      }
    });

    // Show/hide the no results message based on visible count
    noResults.style.display = visibleCount === 0 ? 'block' : 'none';

    // Show/hide the stats based on visible count
    statsSection.style.display = visibleCount === 0 ? 'none' : 'block';

    // Update totals with visible cards
    if (visibleCount > 0) {
      updateTotals(visibleCards);
    }

    if (updateUrl) updateURL();
  }

  // Debounce helper
  function debounce(fn, delay) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  }

  // Replace direct filterCards call with debounced version for input
  const debouncedFilterCards = debounce(() => filterCards(), 500);

  searchBox.addEventListener('input', () => {
    updateClearButton();
    debouncedFilterCards();
  });

  clearButton.addEventListener('click', clearSearch);

  officialToggle.addEventListener('click', () => {
    showOfficial = !showOfficial;
    officialToggle.classList.toggle('active', showOfficial);
    filterCards();
  });

  communityToggle.addEventListener('click', () => {
    showCommunity = !showCommunity;
    communityToggle.classList.toggle('active', showCommunity);
    filterCards();
  });

  hostingToggle.addEventListener('click', () => {
    showHosting = !showHosting;
    hostingToggle.classList.toggle('active', showHosting);
    filterCards();
  });

  clientToggle.addEventListener('click', () => {
    showClient = !showClient;
    clientToggle.classList.toggle('active', showClient);
    filterCards();
  });

  // Also clear when user presses Escape in the search box
  searchBox.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      clearSearch();
    }
  });

  window.addEventListener('popstate', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const search = urlParams.get('search') || '';
    const official = urlParams.get('official') !== 'false';
    const community = urlParams.get('community') !== 'false';
    const hosting = urlParams.get('hosting') !== 'false';
    const client = urlParams.get('client') !== 'false';

    searchBox.value = search;
    showOfficial = official;
    showCommunity = community;
    showHosting = hosting;
    showClient = client;
    officialToggle.classList.toggle('active', showOfficial);
    communityToggle.classList.toggle('active', showCommunity);
    hostingToggle.classList.toggle('active', showHosting);
    clientToggle.classList.toggle('active', showClient);
    updateClearButton();
    filterCards(false);
  });

  filterCards(); // Initial render
  updateClearButton();
  searchBox.focus();
</script>
